<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- æ¨™é¡Œæœƒé¡¯ç¤ºç•¶å‰äººç‰©åç¨± -->
    <title>è£½èŒ¶äºº</title>
    <style>
        /* åŸºç¤ä½ˆå±€èˆ‡æ¨£å¼ (ä½¿ç”¨ Tailwind é¢¨æ ¼å„ªåŒ–å¯è®€æ€§) */
        body { 
            font-family: "Microsoft JhengHei", Arial, sans-serif; 
            display: flex; 
            justify-content: center; /* å±…ä¸­ä½ˆå±€ */
            align-items: flex-start; 
            min-height: 100vh;
            background-color: #f0f2f5; 
            padding: 20px;
        }
        #chat-container { 
            width: 100%;
            max-width: 800px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            padding: 30px; 
            background-color: #ffffff; 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border-radius: 16px;
        }
        #chat-window { 
            height: 500px; /* å¢åŠ é«˜åº¦ */
            border: 1px solid #e0e0e0; 
            overflow-y: scroll; 
            padding: 15px; 
            margin-bottom: 20px; 
            background-color: #fcfcff; /* è¼•å¾®çš„èƒŒæ™¯è‰² */
            border-radius: 10px;
        }
        h2 {
            color: #1a56db; /* ä¸»é¡Œè‰² */
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 0;
            font-weight: 600;
        }
        .message { 
            margin-bottom: 15px; 
            padding: 12px 18px; 
            border-radius: 20px;
            max-width: 80%;
            line-height: 1.6;
        }
        .user { 
            text-align: right; 
            background-color: #e3f2fd; /* æ·ºè—è‰² */
            color: #0d47a1; 
            margin-left: auto;
            border-bottom-right-radius: 4px; /* è®“è§’è½æ›´æœ‰è®ŠåŒ– */
        }
        .assistant { 
            text-align: left; 
            background-color: #f1f8e9; /* æ·ºç¶ è‰² */
            color: #33691e; 
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        textarea { 
            width: 100%; 
            padding: 12px; 
            box-sizing: border-box; 
            resize: none; /* ç¦æ­¢å‚ç›´ç¸®æ”¾ */
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 1em;
        }
        button { 
            padding: 10px 20px; 
            cursor: pointer; 
            border: none; 
            border-radius: 8px; 
            color: white; 
            font-weight: 500;
            margin-right: 15px;
            transition: background-color 0.3s, opacity 0.3s;
        }
        .chat-btn-group button:first-child { 
            background-color: #1a56db; /* è—è‰² */
        }
        .chat-btn-group button:first-child:hover:not(:disabled) { 
            background-color: #1545b8; 
        }
        .chat-btn-group button:last-child { 
            background-color: #f97316; /* æ©˜è‰² */
        }
        .chat-btn-group button:last-child:hover:not(:disabled) { 
            background-color: #e56000; 
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #reset-status {
            font-size: 0.9em;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <!-- èŠå¤©å®¹å™¨ -->
    <div id="chat-container">
        <!-- AI äººç‰©çš„åç¨±æœƒé¡¯ç¤ºåœ¨æ¨™é¡Œä¸­ -->
        <h2 id="chat-title">ğŸ’¬ èˆ‡ å°ç£è£½èŒ¶äºº å°è©±</h2>
        
        <!-- å°è©±è¦–çª— -->
        <div id="chat-window"></div>
        
        <!-- ä½¿ç”¨è€…è¼¸å…¥æ¡† -->
        <textarea id="user-input" rows="4" placeholder="åœ¨æ­¤è¼¸å…¥æ‚¨çš„å•é¡Œ... (æŒ‰ä¸‹ Enter ç™¼é€)" 
            onkeydown="if(event.key === 'Enter' && !event.shiftKey) { sendMessage(); event.preventDefault(); }"></textarea>
        
        <!-- æŒ‰éˆ•çµ„ -->
        <div class="chat-btn-group">
            <button onclick="sendMessage()">ç™¼é€è¨Šæ¯</button>
            <button onclick="resetChat()">é‡ç½®å°è©±</button>
        </div>
        
        <!-- ç‹€æ…‹è¨Šæ¯ -->
        <p id="reset-status"></p>
    </div>

    <script>
        // ğŸš¨ é€™æ˜¯å”¯ä¸€çš„é…ç½®é»ï¼šè«‹ä¿®æ”¹é€™è£¡çš„ AI_PERSONA_ID
        const AI_PERSONA_ID = "teamaker"; 

        // ğŸš¨ é€™æ˜¯æ‚¨çš„ Worker åŸºç¤ URLï¼Œè«‹ç¢ºèªå…¶æ­£ç¢ºæ€§ã€‚
        const WORKER_URL = "https://history-agent.idcllab702.workers.dev";

        let conversationHistory = []; // ç”¨æ–¼å„²å­˜å°è©±æ­·å²

        // *** æ ¸å¿ƒä¿®æ­£é» 1: æ–°å¢äººç‰© ID èˆ‡é¡¯ç¤ºåç¨±çš„å°ç…§è¡¨ ***
        const personaNames = {
            'teamaker': 'å°ç£è£½èŒ¶äºº',
            // å¦‚æœæ‚¨æœ‰æ›´å¤šäººç‰©ï¼Œè«‹åœ¨æ­¤è™•æ“´å……
        };

        // --- è¼”åŠ©å‡½æ•¸ ---

        /** ç²å–èŠå¤© API URL */
        function getChatEndpoint(personaId) {
            return `${WORKER_URL}/api/chat/${personaId}`;
        }

        /** é¡¯ç¤ºè¨Šæ¯åˆ°èŠå¤©çª—å£ */
        function displayMessage(role, content) {
            const chatWindow = document.getElementById('chat-window');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            
            // *** æ ¸å¿ƒä¿®æ­£é» 2: æ ¹æ“šè§’è‰²ä½¿ç”¨æ­£ç¢ºçš„åç¨± ***
            let speakerName;
            if (role === 'user') {
                speakerName = 'æ‚¨';
            } else {
                // AI (assistant) ä½¿ç”¨å°ç…§è¡¨ä¸­çš„ä¸­æ–‡åç¨±ï¼Œå¦‚æœæ‰¾ä¸åˆ°å‰‡ä½¿ç”¨ ID (ä½œç‚ºå‚™ç”¨)
                speakerName = personaNames[AI_PERSONA_ID] || AI_PERSONA_ID; 
            }
            // *** ä¿®æ­£é»çµæŸ ***
            
            msgDiv.innerHTML = `<strong>${speakerName}ï¼š</strong> ${content.replace(/\n/g, '<br>')}`;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // æ»¾å‹•åˆ°åº•éƒ¨
        }

        /** ç™¼é€è¨Šæ¯ä¸¦å‘¼å« Worker API */
        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            const userContent = userInput.value.trim();
            if (!userContent) return;

            const chatEndpoint = getChatEndpoint(AI_PERSONA_ID);
            
            // ç¦ç”¨è¼¸å…¥ï¼Œé˜²æ­¢é‡è¤‡ç™¼é€
            userInput.disabled = true;
            document.querySelector('.chat-btn-group button:first-child').disabled = true;

            displayMessage('user', userContent);
            conversationHistory.push({ role: "user", content: userContent });
            userInput.value = '';

            const payload = { messages: conversationHistory };

            try {
                const response = await fetch(chatEndpoint, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    const assistantResponse = data.response;
                    displayMessage('assistant', assistantResponse);
                    conversationHistory.push({ role: "assistant", content: assistantResponse });
                } else {
                    displayMessage('assistant', `[Worker éŒ¯èª¤ (${response.status}): ${data.error || data.details || 'æœªçŸ¥éŒ¯èª¤'}]`);
                }

            } catch (error) {
                console.error("Fetch éŒ¯èª¤:", error);
                displayMessage('assistant', 
                    `[ç¶²è·¯éŒ¯èª¤ï¼šç„¡æ³•é€£ç·šã€‚è«‹ç¢ºèª Worker URL: ${chatEndpoint} æ­£ç¢ºä¸” Worker å·²éƒ¨ç½²ã€‚]`);
            } finally {
                // é‡æ–°å•Ÿç”¨è¼¸å…¥
                userInput.disabled = false;
                document.querySelector('.chat-btn-group button:first-child').disabled = false;
                userInput.focus(); // è®“æ¸¸æ¨™å›åˆ°è¼¸å…¥æ¡†
            }
        }

        /** æ¸…é™¤å°è©±æ­·å² */
        function resetChat() {
            conversationHistory = [];
            document.getElementById('chat-window').innerHTML = '';
            
            const resetStatus = document.getElementById('reset-status');
            resetStatus.style.color = 'green';
            resetStatus.textContent = "âœ… å°è©±æ­·å²å·²é‡ç½®ï¼æ‚¨å¯ä»¥é–‹å§‹æ–°å°è©±ã€‚";
            
            setTimeout(() => { resetStatus.textContent = ''; }, 3000);
        }

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
             // ç¢ºä¿èŠå¤©æ¨™é¡Œèˆ‡é…ç½®çš„äººç‰©ä¸€è‡´
             const displayName = personaNames[AI_PERSONA_ID] || AI_PERSONA_ID;
             document.getElementById('chat-title').textContent = `ğŸ’¬ èˆ‡ ${displayName} å°è©±`;
        });
    </script>
</body>
</html>