<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A ç¶²ç«™ - AI äººç‰©å°æ¸¬èˆ‡èª¿æ ¡å·¥å…·</title>
    <style>
        /* åŸºç¤ä½ˆå±€èˆ‡æ¨£å¼ (ä½¿ç”¨ Tailwind é¢¨æ ¼å„ªåŒ–å¯è®€æ€§) */
        body { 
            font-family: "Microsoft JhengHei", Arial, sans-serif; 
            display: flex; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f0f2f5; 
        }
        #prompt-panel { 
            width: 35%; /* ç¨å¾®åŠ å¯¬ä»¥å®¹ç´æ›´å¤šæ§åˆ¶é … */
            padding: 20px; 
            background-color: #ffffff; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            margin-right: 20px;
        }
        #chat-panel { 
            width: 65%; 
            padding: 20px; 
            background-color: #ffffff; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        #chat-window { 
            height: 400px; 
            border: 1px solid #e0e0e0; 
            overflow-y: scroll; 
            padding: 15px; 
            margin-bottom: 15px; 
            background-color: #fafafa; 
            border-radius: 8px;
        }
        .message { 
            margin-bottom: 15px; 
            padding: 10px 15px; 
            border-radius: 15px;
            max-width: 85%;
        }
        .user { 
            text-align: right; 
            background-color: #bbdefb; /* æ·ºè—è‰² */
            color: #0d47a1; 
            margin-left: auto;
        }
        .assistant { 
            text-align: left; 
            background-color: #fce4ec; /* æ·ºç²‰è‰² */
            color: #ad1457; 
            margin-right: auto;
        }
        textarea, select { 
            width: 100%; 
            padding: 12px; 
            box-sizing: border-box; 
            resize: vertical; 
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 1em;
        }
        button { 
            padding: 10px 15px; 
            cursor: pointer; 
            border: none; 
            border-radius: 6px; 
            color: white; 
            margin-top: 5px;
            margin-right: 10px;
            transition: background-color 0.3s, opacity 0.3s;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #prompt-load-btn { background-color: #00bcd4; } /* é’è‰² */
        #prompt-load-btn:hover:not(:disabled) { background-color: #0097a7; }
        #prompt-save-btn { background-color: #2196F3; } /* è—è‰² */
        #prompt-save-btn:hover:not(:disabled) { background-color: #1e87e5; }
        .chat-btn-group button:last-child { background-color: #f44336; }
        .chat-btn-group button:last-child:hover:not(:disabled) { background-color: #d32f2f; }

        .persona-label, .prompt-desc {
            font-weight: bold;
            margin-top: 15px;
            display: block;
            color: #333;
        }
        .prompt-desc {
            font-size: 0.9em;
            font-weight: normal;
            margin-top: 5px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            border-left: 3px solid #ccc;
        }
        #prompt-status {
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <!-- æç¤ºè©èª¿æ ¡é¢æ¿ (A ç¶²ç«™ç¨æœ‰) -->
    <div id="prompt-panel">
        <h2>ğŸ’Š æç¤ºè©ç®¡ç† (A ç¶²ç«™å°ˆç”¨)</h2>
        
        <label for="persona-id-select" class="persona-label">ğŸ‘¤ é¸æ“‡ AI äººç‰© (KV Key):</label>
        <!-- ä¸‹æ‹‰é¸å–®æ›¿æ› -->
        <select id="persona-id-select" onchange="updateNotesAndTitle(this.value); resetChat();">
            <option value="teamaker" selected>teamaker</option>
            <option value="system_prompt_history_person">system_prompt_history_person</option>
        </select>
        
        <p class="prompt-desc" id="persona-notes"></p>

        <label for="prompt-input" class="persona-label" style="margin-top: 10px;">ğŸ“œ ç³»çµ±æç¤ºè©å…§å®¹:</label>
        <textarea id="prompt-input" rows="15" placeholder="è«‹å…ˆé»æ“Šã€Œè®€å–ç›®å‰æç¤ºè©ã€æŒ‰éˆ•è¼‰å…¥å…§å®¹ã€‚æ­¤è™•é¡¯ç¤ºçš„æ˜¯ç•¶å‰äººç‰©åœ¨ KV ä¸­çš„æç¤ºè©ã€‚"></textarea>

        <!-- æ–°å¢è®€å–æŒ‰éˆ• -->
        <button id="prompt-load-btn" onclick="loadPrompt()">ğŸ”„ è®€å–ç›®å‰æç¤ºè©</button>
        <button id="prompt-save-btn" onclick="savePrompt()" disabled>ğŸ’¾ ä¿å­˜/æ›´æ–°æç¤ºè©</button>
        
        <p id="prompt-status" style="color: red; margin-top: 10px; font-weight: bold;">è«‹å…ˆé¸æ“‡äººç‰©ä¸¦è¼‰å…¥æç¤ºè©ã€‚</p>
        
        <p style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; font-size: 0.9em; color: #666;">
            æ³¨æ„ï¼šä¿å­˜æˆåŠŸå¾Œï¼Œå°è©±æ­·å²æœƒè‡ªå‹•é‡ç½®ï¼Œä»¥ä¾¿ä½¿ç”¨æ–°çš„æç¤ºè©é€²è¡Œæ¸¬è©¦ã€‚
        </p>
    </div>

    <!-- èŠå¤©é¢æ¿ -->
    <div id="chat-panel">
        <h2 id="chat-title">ğŸ’¬ èˆ‡ AI äººç‰© å°è©±</h2>
        <div id="chat-window"></div>
        <textarea id="user-input" rows="3" placeholder="åœ¨æ­¤è¼¸å…¥æ‚¨çš„å•é¡Œ..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { sendMessage(); event.preventDefault(); }"></textarea>
        <div class="chat-btn-group">
            <button onclick="sendMessage()">ç™¼é€è¨Šæ¯</button>
            <button onclick="resetChat()">é‡ç½®å°è©±</button>
        </div>
        <!-- ç”¨æ–¼é¡¯ç¤ºé‡ç½®æˆåŠŸçš„è¨Šæ¯ -->
        <p id="reset-status" style="color: green; margin-top: 10px; font-weight: bold;"></p>
    </div>

    <script>
        // ğŸš¨ é€™æ˜¯æ‚¨çš„ Worker åŸºç¤ URLï¼Œè«‹å†æ¬¡ç¢ºèªå…¶æ­£ç¢ºæ€§ã€‚
        const WORKER_URL = "https://history-agent.idcllab702.workers.dev";
        let conversationHistory = []; // ç”¨æ–¼å„²å­˜å°è©±æ­·å²

        const personaDescriptions = {
            teamaker: "teamaker æ˜¯å°ç£è£½èŒ¶äººã€‚",
            system_prompt_history_person: "é€™æ˜¯æ¸¬è©¦ç”¨äººç‰©ï¼Œç”¨æ–¼å¿«é€Ÿé©—è­‰ Worker é€£ç·šã€‚"
        };

        // --- è¼”åŠ©å‡½æ•¸ ---

        /** å–å¾—ç›®å‰é¸æ“‡çš„äººç‰© ID */
        function getPersonaId() {
            return document.getElementById('persona-id-select').value.trim();
        }

        /** ç²å–èŠå¤© API URL */
        function getChatEndpoint(personaId) {
            return `${WORKER_URL}/api/chat/${personaId}`;
        }

        /** ç²å–ç®¡ç† API URL (è®€å–æˆ–ä¿å­˜éƒ½ä½¿ç”¨æ­¤ URL) */
        function getAdminEndpoint(personaId) {
            return `${WORKER_URL}/api/admin/prompt/${personaId}`;
        }

        /** æ›´æ–°èŠå¤©çª—å£çš„æ¨™é¡Œå’Œå‚™è¨» */
        function updateNotesAndTitle(personaId) {
            document.getElementById('chat-title').textContent = `ğŸ’¬ èˆ‡ AI äººç‰© ${personaId} å°è©±`;
            document.getElementById('persona-notes').textContent = personaDescriptions[personaId] || "ç„¡ç›¸é—œå‚™è¨»ã€‚";
        }

        /** æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ */
        function updatePromptButtonState(canSave) {
            document.getElementById('prompt-save-btn').disabled = !canSave;
            document.getElementById('prompt-load-btn').disabled = false;
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè®€å– KV æç¤ºè© ---

        async function loadPrompt() {
            const personaId = getPersonaId();
            const statusElement = document.getElementById('prompt-status');
            const promptInput = document.getElementById('prompt-input');
            const loadBtn = document.getElementById('prompt-load-btn');

            loadBtn.disabled = true;
            statusElement.textContent = `æ­£åœ¨è®€å–äººç‰© ${personaId} çš„æç¤ºè©...`;
            statusElement.style.color = '#FFA500'; // æ©™è‰²è¡¨ç¤ºç­‰å¾…

            try {
                const endpointUrl = getAdminEndpoint(personaId);
                const response = await fetch(endpointUrl, {
                    method: 'GET', // é€™è£¡å¿…é ˆæ˜¯ GET è«‹æ±‚
                    headers: { 'Content-Type': 'application/json' }
                });
                
                let data;
                
                if (response.ok) {
                    // æˆåŠŸæ™‚ï¼Œå˜—è©¦è§£æ JSON
                    try {
                        data = await response.json();
                    } catch (e) {
                        // è™•ç† Worker æˆåŠŸè¿”å›ä½†å…§å®¹ä¸æ˜¯ JSON çš„é‚Šç·£æƒ…æ³
                        throw new Error("Worker æˆåŠŸå›æ‡‰ï¼Œä½†å…§å®¹ç„¡æ³•è§£æç‚º JSONã€‚");
                    }
                    
                    // å‡è¨­æˆåŠŸæ™‚ï¼ŒWorker è¿”å›çš„ JSON çµæ§‹ä¸­åŒ…å« prompt å­—æ®µ
                    const systemPrompt = data.prompt || data.response; 

                    if (systemPrompt) {
                        promptInput.value = systemPrompt;
                        statusElement.textContent = `âœ… æç¤ºè©è®€å–æˆåŠŸï¼æ™‚é–“: ${new Date().toLocaleTimeString('zh-TW')}ã€‚ç¾åœ¨å¯ä»¥ä¿®æ”¹ä¸¦ä¿å­˜ã€‚`;
                        statusElement.style.color = 'green';
                        updatePromptButtonState(true); // å•Ÿç”¨ä¿å­˜æŒ‰éˆ•
                    } else {
                        throw new Error("Worker è¿”å›çš„è³‡æ–™çµæ§‹ä¸­ç¼ºå°‘æç¤ºè©å…§å®¹ (prompt/response å­—æ®µ)ã€‚");
                    }
                } else {
                    // å¤±æ•—æ™‚ï¼Œè®€å–éŒ¯èª¤æ–‡æœ¬ä»¥ç²å¾—è©³ç´°è³‡è¨Š
                    const errorText = await response.text();
                    // æ‹‹å‡ºæ›´å…·é«”ã€æœ‰åŠ©æ–¼ Worker é™¤éŒ¯çš„éŒ¯èª¤
                    // *** ä¿®æ­£ï¼šåœ¨éŒ¯èª¤è¨Šæ¯ä¸­æ˜ç¢ºåŒ…å«è«‹æ±‚çš„ URL ***
                    throw new Error(`Worker éŒ¯èª¤ (${response.status} ${response.statusText}): è«‹æ±‚ URL: ${endpointUrl}ã€‚ä¼ºæœå™¨å›æ‡‰: ${errorText.substring(0, 100)}... (è«‹ç¢ºèª Worker å·²å¯¦ä½œ GET è«‹æ±‚)`);
                }
            } catch (error) {
                console.error("Load Prompt Error:", error);
                // é¡¯ç¤ºå¾ Worker å–å¾—çš„è©³ç´°éŒ¯èª¤è¨Šæ¯
                statusElement.textContent = `âŒ è®€å–å¤±æ•—: ${error.message}`;
                statusElement.style.color = 'red';
                promptInput.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
                updatePromptButtonState(false); // ç¦ç”¨ä¿å­˜æŒ‰éˆ•
            } finally {
                loadBtn.disabled = false;
            }
        }


        // --- æç¤ºè©ç®¡ç†åŠŸèƒ½ (ä¿å­˜) ---

        async function savePrompt() {
            const promptInput = document.getElementById('prompt-input');
            const newPrompt = promptInput.value.trim();
            const statusElement = document.getElementById('prompt-status');
            
            const personaId = getPersonaId();
            const adminEndpoint = getAdminEndpoint(personaId); 

            if (!newPrompt) {
                statusElement.textContent = "æç¤ºè©å…§å®¹ä¸èƒ½ç‚ºç©ºï¼";
                return;
            }

            statusElement.textContent = "æ­£åœ¨ä¿å­˜...";
            statusElement.style.color = '#FFA500'; 
            
            try {
                const response = await fetch(adminEndpoint, {
                    method: 'POST', // ä¿å­˜ä½¿ç”¨ POST è«‹æ±‚
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newPrompt: newPrompt })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusElement.textContent = `âœ… æç¤ºè©ä¿å­˜æˆåŠŸï¼äººç‰© ID: ${personaId}ã€‚æ™‚é–“: ${new Date().toLocaleTimeString('zh-TW')}`;
                    statusElement.style.color = 'green';
                    resetChat(); // å»ºè­°é‡ç½®å°è©±ä»¥ä½¿ç”¨æ–°æç¤ºè©
                } else {
                    statusElement.textContent = `âŒ ä¿å­˜å¤±æ•—: ${data.details || data.message || 'æœªçŸ¥éŒ¯èª¤'}`;
                    statusElement.style.color = 'red';
                }

            } catch (error) {
                statusElement.textContent = `âŒ ç¶²è·¯éŒ¯èª¤ï¼šç„¡æ³•é€£ç·šåˆ° Worker Admin æ¥å£ã€‚`;
                statusElement.style.color = 'red';
            }
        }

        // --- èŠå¤©åŠŸèƒ½ ---

        /** é¡¯ç¤ºè¨Šæ¯åˆ°èŠå¤©çª—å£ */
        function displayMessage(role, content) {
            const chatWindow = document.getElementById('chat-window');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            
            // æ ¹æ“šè§’è‰²é¡¯ç¤ºä¸åŒçš„åç¨±
            let speakerName = role === 'user' ? 'æ‚¨' : getPersonaId();
            
            msgDiv.innerHTML = `<strong>${speakerName}ï¼š</strong> ${content.replace(/\n/g, '<br>')}`;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // æ»¾å‹•åˆ°åº•éƒ¨
        }

        /** ç™¼é€è¨Šæ¯ä¸¦å‘¼å« Worker API */
        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            const userContent = userInput.value.trim();
            if (!userContent) return;

            const personaId = getPersonaId();
            const chatEndpoint = getChatEndpoint(personaId);

            displayMessage('user', userContent);
            conversationHistory.push({ role: "user", content: userContent });
            userInput.value = '';

            const payload = { messages: conversationHistory };

            try {
                const response = await fetch(chatEndpoint, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    const assistantResponse = data.response;
                    displayMessage('assistant', assistantResponse);
                    conversationHistory.push({ role: "assistant", content: assistantResponse });
                } else {
                    displayMessage('assistant', `[Worker éŒ¯èª¤ (${response.status}): ${data.error || data.details || 'æœªçŸ¥éŒ¯èª¤'}]`);
                }

            } catch (error) {
                console.error("Fetch éŒ¯èª¤:", error);
                displayMessage('assistant', 
                    `[ç¶²è·¯éŒ¯èª¤ï¼šç„¡æ³•é€£ç·šã€‚è«‹ç¢ºèª Worker URL: ${chatEndpoint} æ­£ç¢ºä¸” Worker å·²éƒ¨ç½²ã€‚]`);
            }
        }

        /** æ¸…é™¤å°è©±æ­·å² */
        function resetChat() {
            conversationHistory = [];
            document.getElementById('chat-window').innerHTML = '';
            
            const resetStatus = document.getElementById('reset-status');
            resetStatus.textContent = "âœ… å°è©±æ­·å²å·²é‡ç½®ï¼æ‚¨å¯ä»¥é–‹å§‹æ–°å°è©±ã€‚";
            
            setTimeout(() => { resetStatus.textContent = ''; }, 3000);
        }

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            const initialId = getPersonaId();
            updateNotesAndTitle(initialId);
            // ç¢ºä¿ä¸€é–‹å§‹ä¿å­˜æŒ‰éˆ•æ˜¯ç¦ç”¨çš„
            document.getElementById('prompt-save-btn').disabled = true;
        });
    </script>
</body>
</html>